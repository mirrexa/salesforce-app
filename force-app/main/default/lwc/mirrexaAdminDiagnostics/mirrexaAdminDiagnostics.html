<template>
  <lightning-card
    title="Debug and Diagnostic Information"
    icon-name="standard:settings"
  >
    <div class="slds-var-p-horizontal_medium">
      <template if:true={isLoading}>
        <lightning-spinner
          alternative-text="Loading dashboard data..."
        ></lightning-spinner>
      </template>

      <template if:false={isLoading}>
        <!-- Named Credential Check -->
        <template if:true={namedCredentialExists}>
          <div class="slds-var-m-bottom_large">
            <h3 class="slds-text-heading_small slds-var-m-bottom_small">
              Named Credential Configuration
            </h3>
            <div class="slds-box">
              Please ensure the "Enable for Callouts" toggle is enabled for the
              Mirrexa_API Named Credential.
              <div class="slds-var-m-top_small">
                <a
                  href={namedCredentialUrl}
                  target="_blank"
                  class="slds-button slds-button_neutral"
                >
                  <lightning-icon
                    icon-name="utility:new_window"
                    size="x-small"
                    class="slds-var-m-right_x-small"
                  ></lightning-icon>
                  Open Mirrexa_API Named Credential
                </a>
              </div>
            </div>
          </div>
        </template>

        <!-- Permission Debug Button -->
        <div class="slds-var-m-bottom_large">
          <h3 class="slds-text-heading_small slds-var-m-bottom_small">
            Diagnostic Tools
          </h3>
          <div class="slds-box slds-theme_info slds-var-m-bottom_small">
            The "Debug Permission Setup" button will assist you in diagnosing
            any permission issues that may be preventing the Mirrexa App from
            functioning correctly. This will work for your (System
            Administrator) user profile only.
          </div>
          <lightning-button
            label="Debug Permission Setup"
            onclick={handleDebugPermissions}
            variant="neutral"
            icon-name="utility:bug"
          >
          </lightning-button>
          <template if:true={permissionDebugInfo}>
            <div class="slds-var-m-top_small">
              <div class="slds-box slds-theme_shade">
                <h4 class="slds-text-heading_small slds-var-m-bottom_small">
                  Debug Output:
                </h4>
                <pre class="slds-text-body_small">{permissionDebugInfo}</pre>
              </div>
            </div>
          </template>
        </div>

        <!-- Setup Status Summary -->
        <div class="slds-var-m-bottom_large">
          <h3 class="slds-text-heading_small slds-var-m-bottom_small">
            Setup Status
          </h3>
          <div class="slds-box slds-theme_info slds-var-m-bottom_small">
            This will tell you the last time the setup was completed and any
            errors that occurred. If you see errors here then contact the
            Mirrexa Support Team at&nbsp;
            <a href="mailto:team@mirrexa.ai">team@mirrexa.ai</a>.
          </div>
          <div class="slds-box">
            <lightning-badge
              label={setupStatus}
              variant={setupStatusVariant}
            ></lightning-badge>

            <template if:true={hasCompletedSteps}>
              <div class="slds-var-m-top_small">
                <h4 class="slds-text-heading_small">Completed Steps:</h4>
                <ul class="slds-list_dotted">
                  <li class="slds-text-color_success">
                    {setupResult.lastSuccess}
                  </li>
                  <li class="slds-text-color_success">
                    {setupResult.lastSuccessTime}
                  </li>
                </ul>
              </div>
            </template>

            <template if:true={hasSetupErrors}>
              <div class="slds-var-m-top_small">
                <h4 class="slds-text-heading_small slds-text-color_error">
                  Setup Errors:
                </h4>
                <div
                  class="slds-box slds-box_x-small slds-theme_error slds-var-m-top_x-small"
                >
                  {setupResult.lastError} at {setupResult.lastErrorTime}
                </div>
              </div>
            </template>
          </div>
        </div>
      </template>
    </div>
  </lightning-card>
</template>
